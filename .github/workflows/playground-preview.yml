name: WordPress Playground Preview (PR & Comments)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  issue_comment:
    types: [created, edited]

permissions: {}

env:
  # Cambia se il workflow di build ha un nome diverso
  BUILD_WORKFLOW_NAME: Build Plugin
  # Cambia se l'artifact ha un nome diverso
  ARTIFACT_NAME_FALLBACK: bluehost-wordpress-plugin

jobs:
  deploy-preview:
    runs-on: ubuntu-latest

    # Se Ã¨ un commento, esegui solo se l'issue Ã¨ una PR
    if: github.event_name == 'pull_request' || (github.event_name == 'issue_comment' && github.event.issue.pull_request)

    permissions:
      contents: read
      actions: read
      pages: write
      id-token: write
      pull-requests: write

    concurrency:
      group: pages
      cancel-in-progress: true

    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Resolve PR context (number/branch/commit)
        id: ctx
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            let prNumber, branch, commit;

            if (context.eventName === 'pull_request') {
              prNumber = context.payload.pull_request.number;
              branch   = context.payload.pull_request.head.ref;
              commit   = context.payload.pull_request.head.sha.slice(0,7);
            } else {
              // issue_comment
              prNumber = context.payload.issue.number;
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
              });
              branch = pr.head.ref;
              commit = pr.head.sha.slice(0,7);
            }

            core.setOutput('number', prNumber.toString());
            core.setOutput('branch', branch);
            core.setOutput('commit', commit);
      

      - name: Find latest successful "Build Plugin" run for this branch
        id: find_run
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        env:
          BRANCH: ${{ steps.ctx.outputs.branch }}
          WORKFLOW_NAME: ${{ env.BUILD_WORKFLOW_NAME }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branch = process.env.BRANCH;
            const WORKFLOW_NAME = process.env.WORKFLOW_NAME;

            const { data } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch,
              event: 'pull_request',
              status: 'success',
              per_page: 50,
            });

            const run = data.workflow_runs.find(r => r.name === WORKFLOW_NAME);
            if (!run) {
              core.setFailed(`âŒ No successful "${WORKFLOW_NAME}" run found on branch ${branch}.`);
              return;
            }

            core.setOutput('run_id', run.id.toString());
            core.setOutput('run_name', run.name);
            core.setOutput('head_sha', run.head_sha.slice(0,7));
            core.info(`âœ… Found successful build run #${run.id} (${run.name}) for branch ${branch}`);
      

      - name: Download build artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: ${{ vars.PLUGIN_NAME || env.ARTIFACT_NAME_FALLBACK }}
          path: ./artifact
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.find_run.outputs.run_id }}

      - name: Prepare zip for Pages
        id: prepare
        run: |
          set -euo pipefail

          mkdir -p gh-pages/previews

          PR_NUM="${{ steps.ctx.outputs.number }}"
          ZIP_NAME="bluehost-pr-${PR_NUM}.zip"

          cd artifact
          zip -r -9 "../gh-pages/previews/${ZIP_NAME}" .
          cd ..

          SIZE=$(du -h "gh-pages/previews/${ZIP_NAME}" | cut -f1)

          echo "zip_name=${ZIP_NAME}" >> "$GITHUB_OUTPUT"
          echo "zip_size=${SIZE}" >> "$GITHUB_OUTPUT"

          cat > gh-pages/previews/index.html <<EOF
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8" />
            <title>Bluehost Plugin - Playground Previews</title>
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
              h1 { color: #333; }
              .preview { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
              a { color: #0969da; text-decoration: none; }
              a:hover { text-decoration: underline; }
              code { background:#eee; padding:2px 6px; border-radius:4px; }
            </style>
          </head>
          <body>
            <h1>ðŸŽ® WordPress Playground Previews</h1>
            <p>Preview builds of the Bluehost WordPress Plugin for testing in WordPress Playground.</p>
            <div class="preview">
              <p><strong>Latest:</strong> <a href="${ZIP_NAME}">${ZIP_NAME}</a> (${SIZE})</p>
            </div>
          </body>
          </html>
          EOF

      - name: Configure Pages
        uses: actions/configure-pages@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          enablement: true

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@56afc609e74202658d3ffba0e8f6dda462b719fa # v3.0.1
        with:
          path: ./gh-pages

      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5

      - name: Comment Playground link on PR
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        env:
          PR_NUMBER: ${{ steps.ctx.outputs.number }}
          ZIP_NAME: ${{ steps.prepare.outputs.zip_name }}
          ZIP_SIZE: ${{ steps.prepare.outputs.zip_size }}
          COMMIT: ${{ steps.ctx.outputs.commit }}
          BRANCH: ${{ steps.ctx.outputs.branch }}
          PAGES_URL: ${{ steps.deploy.outputs.page_url }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = Number(process.env.PR_NUMBER);
            const zipName  = process.env.ZIP_NAME;
            const zipSize  = process.env.ZIP_SIZE;
            const commit   = process.env.COMMIT;
            const branch   = process.env.BRANCH;

            const base = process.env.PAGES_URL.replace(/\/+$/, '');
            const zipUrl = `${base}/previews/${zipName}`;

            const blueprint = {
              landingPage: "/wp-admin/admin.php?page=bluehost#/home",
              preferredVersions: { php: "8.1", wp: "latest" },
              login: true,
              steps: [{
                step: "installPlugin",
                pluginData: { resource: "url", url: zipUrl },
                options: { activate: true }
              }]
            };

            const blueprintBase64 = Buffer.from(JSON.stringify(blueprint)).toString('base64');
            const playgroundUrl = `https://playground.wordpress.net/#${blueprintBase64}`;

            const commentMeta = '<!-- playground-preview-link -->';
            const body = `
            ${commentMeta}
            ## ðŸŽ® WordPress Playground Preview

            [**â–¶ï¸ Launch Preview in Playground**](${playgroundUrl})

            **Preview Details**
            - ðŸ“¦ \`${zipName}\` (${zipSize})
            - ðŸ—‚ï¸ Branch: \`${branch}\`
            - ðŸ“ Commit: \`${commit}\`
            - ðŸ”— [Direct Download](${zipUrl})
            `;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            const existing = comments.find(c => c.body && c.body.includes(commentMeta));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body,
              });
            }
